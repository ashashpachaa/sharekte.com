name: Deploy to Hostinger VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Hostinger VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          script: |
            cd /var/www/sharekte.com
            echo "ğŸš€ Deploying sharekte.com to Hostinger VPS..."

            # Pull latest code from GitHub
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git fetch origin main
            git reset --hard origin/main

            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm install -g pnpm
            pnpm install --frozen-lockfile

            # Build the application
            echo "ğŸ”¨ Building application..."
            npm run build

            # Use PM2 for process management
            echo "ğŸ›‘ Restarting application with PM2..."
            pm2 restart sharekte || pm2 start ecosystem.config.js

            # Wait for server to start
            sleep 3

            # Check if server is running
            echo "ğŸ¥ Performing health check..."
            if curl -f http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ… Deploy successful! Server is running."
              pm2 save
            else
              echo "âŒ Deploy failed! Health check didn't pass."
              pm2 logs sharekte
              exit 1
            fi
