name: Deploy to Hostinger VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Deploy to Hostinger VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOSTINGER_HOST }}
          username: ${{ secrets.HOSTINGER_USER }}
          key: ${{ secrets.HOSTINGER_SSH_KEY }}
          port: ${{ secrets.HOSTINGER_PORT }}
          script: |
            cd /var/www/sharekte.com
            echo "âœ… Deploying sharekte.com..."
            
            # Pull latest code from GitHub
            echo "ğŸ“¥ Pulling latest code from GitHub..."
            git fetch origin main
            git reset --hard origin/main
            
            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm install -g pnpm
            pnpm install --frozen-lockfile
            
            # Build the application
            echo "ğŸ”¨ Building application..."
            npm run build
            
            # Kill old process
            echo "ğŸ›‘ Stopping old server..."
            pkill -f "node dist/server/node-build.mjs" || true
            sleep 2
            
            # Start new process in background
            echo "ğŸš€ Starting new server..."
            nohup npm start > /var/log/sharekte.log 2>&1 &
            
            # Wait for server to start
            sleep 3
            
            # Check if server is running
            if curl -f http://localhost:8080/health > /dev/null 2>&1; then
              echo "âœ… Deploy successful! Server is running."
            else
              echo "âŒ Deploy failed! Health check didn't pass."
              exit 1
            fi
